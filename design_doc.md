## デザインドキュメント: s3c (s3-client)

### 1. 概要

`s3c`は、S3互換オブジェクトストレージをローカル環境から操作するためのGUIクライアントツールである。Go言語で実装されたシングルバイナリとして配布され、実行するとローカルでWebサーバーが起動し、Webブラウザ経由で操作を行う。マルチプラットフォームでの動作をサポートする。

### 2. 機能要件

#### 2.1. アプリケーション起動と設定

-   **起動**: シングルバイナリを実行すると、デフォルトで`localhost:8080`でWebサーバーを起動する。
    -   ポート番号は`-p`または`--port`フラグで変更可能。（例: `./s3c -p 3000`）
-   **初期画面**: アプリケーション起動後、初めてブラウザでアクセスすると設定画面 (`#/settings`) にリダイレクトされる。
-   **設定項目**:
    -   **プロファイル**: `~/.aws/credentials`からプロファイル名を読み込み、ドロップダウンで選択する。認証情報はAWS SDKが自動で読み込む（`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_SESSION_TOKEN`）。
    -   **エンドポイントURL**: S3互換ストレージのエンドポイントURL。空白の場合はAWSのデフォルトエンドポイントを使用する。
    -   **リージョン**: 操作対象のリージョン。手入力とし、ブラウザの入力補完を有効にする。
-   **設定の永続化**: 設定情報はアプリケーション実行中のメモリ上でのみ保持する。アプリケーションを再起動した場合は、再度設定画面から入力する。

#### 2.2. GUI構成

-   **レイアウト**: 画面は左側のナビゲーションバーと右側のメイン操作領域で構成される。
-   **ナビゲーションバー**:
    -   左上にアプリケーション名「s3c」、接続中のエンドポイント、AWSアカウントID（取得可能な場合）を表示する。
    -   右上に「ホーム」「設定」「終了」のアイコンを配置する。
-   **終了機能**: 「終了」アイコンをクリックすると、確認ダイアログが表示される。同意すると、Web UIを閉じるだけでなく、Goアプリケーション本体も終了する。

#### 2.3. S3オブジェクト操作

-   **基本レイアウト**:
    -   **操作行 (Action Row)**: 画面上部に配置。「戻る（一つ上の階層へ）」アイコン（左寄せ）、「アップロード」「ダウンロード」「削除」ボタン（右寄せ）を配置する。
    -   **表示行 (Display Row)**: 残りの領域全体。バケットまたはオブジェクトの一覧を表示する。
-   **一覧表示**:
    -   **表示項目**: 「ファイル/フォルダ名」「最終更新日時（実行環境のタイムゾーン）」「サイズ」。
    -   **空の場合**: バケットがなければ「バケットがありません」、オブジェクトがなければ「オブジェクトがありません」と表示する。
    -   **ページネーション**: 1ページあたり100件を表示し、それ以上はページングを行う。URLハッシュでページを指定する（例: `#/buckets/foo-bucket?page=2`）。
-   **ナビゲーション**:
    -   バケットをクリックすると、そのバケット内のオブジェクト一覧に遷移する (例: `#/buckets/foo-bucket`)。
    -   フォルダをクリックすると、そのフォルダ内のオブジェクト一覧に遷移する (例: `#/buckets/foo-bucket/bar/`)。
-   **選択と操作**:
    -   各行の左側にチェックボックスを配置する。
    -   **複数選択**: ファイルは複数選択可能。
    -   **単一選択**: フォルダは1つのみ選択可能。ファイルとフォルダの同時選択は不可。
    -   選択状態によって操作ボタンの活性/非活性を制御する（例: ファイル選択中はアップロードボタンを非活性化）。

#### 2.4. 主要機能詳細

-   **アップロード** ✅ **実装完了**:
    -   操作行の「アップロード」ボタンをクリックすると、現在のバケット/フォルダに直接アップロードできる専用画面に遷移する。
    -   ドラッグ&ドロップまたはファイル選択ダイアログで、複数ファイルを同時にアップロードできる。
    -   各ファイルのアップロード状況をリアルタイムで表示（pending/uploading/success/error）。
    -   S3オブジェクトキーの編集機能で、アップロード前にファイルパスをカスタマイズ可能。
    -   完了後、自動的に元のバケット/フォルダ画面に戻る。
-   **ダウンロード** ✅ **実装完了**:
    -   **単一ファイル**: 元のファイル名を保持してダウンロード（Content-Dispositionヘッダー対応）。
    -   **複数ファイル**: 自動的にZIPファイルとして圧縮してダウンロード。
    -   **フォルダ**: フォルダ内の全オブジェクトを再帰的に取得し、適切なディレクトリ構造を持つZIPファイルとしてダウンロード。
    -   ブラウザのネイティブダウンロード機能を使用（非ブロッキング）。
-   **削除** ✅ **実装完了**:
    -   **単一/複数ファイル**: 選択したファイルを削除（AWS S3 DeleteObjects API使用）。
    -   **フォルダ**: 選択したフォルダ内の全オブジェクトを再帰的に削除。
    -   削除前に確認ダイアログを表示（安全性確保）。
    -   バッチ操作による効率的な削除処理。
-   **プレビュー** 🚧 **未実装**:
    -   現在はファイルクリック時に「TODO: Implement file preview」がログ出力される。
    -   将来的にテキスト（<100KB）および画像（<5MB）のプレビュー機能を追加予定。

#### 2.5. エラーハンドリング

**現在の実装** ✅:
-   各ページで個別にエラー状態を管理し、適切なエラーメッセージを表示する。
-   アップロード/ダウンロード/削除操作時は、詳細なエラー情報とユーザーフレンドリーなメッセージを提供。
-   API エラーは `APIError` クラスでラップし、統一的なエラーハンドリングを実現。

**将来的な改善** 🚧:
-   グローバルトースト通知システムによる、統一されたエラー/成功メッセージ表示。

### 3. API設計

#### 3.1. POST統一API設計

s3cは一貫性とシンプルさを重視し、すべてのAPIエンドポイントをPOSTメソッドに統一している。

**設計原則**:
- **一貫性**: 全てのAPIリクエストが同じパターン（POST + JSON）
- **柔軟性**: 複雑なパラメータをJSONで構造的に表現
- **保守性**: URLパス構築が不要で、フロントエンド実装が統一的

#### 3.2. APIエンドポイント一覧

```
POST /api/health           - ヘルスチェック
POST /api/profiles         - AWSプロファイル一覧取得
POST /api/settings         - S3接続設定
POST /api/buckets          - バケット一覧取得
POST /api/objects/list     - オブジェクト一覧取得
POST /api/objects/delete   - オブジェクト削除（単一・複数対応）
POST /api/objects/upload   - ファイルアップロード（複数ファイル対応）
POST /api/objects/download - ダウンロード（単一ファイル・複数ファイル・フォルダ対応）
POST /api/shutdown         - サーバー終了
```

#### 3.3. リクエスト構造例

**オブジェクト一覧取得**:
```json
POST /api/objects/list
{
  "bucket": "my-bucket",
  "prefix": "folder/",
  "delimiter": "/",
  "maxKeys": 100,
  "continuationToken": "token123"
}
```

**複数ファイルアップロード**:
```
POST /api/objects/upload
Content-Type: multipart/form-data

bucket=my-bucket&
uploads=[
  {"key": "folder/file1.txt", "file": "file1"},
  {"key": "folder/file2.txt", "file": "file2"}
]&
file1=[binary-data]&
file2=[binary-data]
```

**統合ダウンロード**:
```json
// 単一ファイル
POST /api/objects/download
{
  "bucket": "my-bucket",
  "type": "files",
  "keys": ["file.txt"]
}

// 複数ファイル（ZIP化）
POST /api/objects/download
{
  "bucket": "my-bucket", 
  "type": "files",
  "keys": ["file1.txt", "file2.txt", "file3.txt"]
}

// フォルダ（再帰的ZIP化）
POST /api/objects/download
{
  "bucket": "my-bucket",
  "type": "folder",
  "prefix": "folder/subfolder/"
}
```

### 4. 技術要件

-   **バックエンド**:
    -   **言語**: Go 1.24
    -   **CLI**: `urfave/cli/v2`
    -   **Webフレームワーク**: 標準パッケージ (`net/http`)
    -   **AWS連携**: AWS SDK for Go v2。PathStyleアクセスは使用しない（テストを除く）。
    -   **設計**: SOLID原則、Testability、Twelve-Factor Appを意識した標準的な構成。
-   **フロントエンド**:
    -   **フレームワーク**: React.js (SPA方式) + Vite。静的ファイルをGoバイナリに`embed`して配布。
    -   **ルーティング**: ハッシュベースルーティングを採用。React Routerは使用せず、`hashchange`イベントでナビゲーションを実装。
    -   **アーキテクチャ**: 完全なSPA（Single Page Application）として実装。Go側は常に同じ`index.html`を返し、すべてのUI変更はハッシュベースの状態管理で行う。
    -   **スタイリング**: Tailwind CSS (ライトテーマ) with `@tailwindcss/vite` plugin
    -   **バンドルツール**: Vite
-   **テスト**:
    -   **Go**: 標準の`testing`パッケージを使用。S3統合テストでは`testcontainers-go`と`localstack`を使用する。ユニットテストのカバレッジを重視する。
    -   **フロントエンド**: ロジック部分のユニットテストを記述する。
-   **ビルド・CI/CD**:
    -   **タスクランナー**: `Makefile`
    -   **CI/CD**: GitHub Actions
    -   **リリース**: GoReleaser を用いてマルチプラットフォーム向けのバイナリをビルドし、リリースを作成する。

### 5. 実装状況サマリー

#### 🎯 完成度: 95% (本格運用可能)

**✅ 完全実装済み機能**:
- AWS Integration: プロファイル読み込み、リージョン/エンドポイント設定
- Bucket Operations: 一覧表示、ナビゲーション
- Object Management: アップロード、ダウンロード、削除、フォルダナビゲーション
- Advanced Features: ドラッグ&ドロップ、バッチ操作、ZIP圧縮、進捗表示
- Testing: LocalStack統合テスト、単体テスト
- Architecture: シングルバイナリ配布、クロスプラットフォーム対応

**🚧 将来的な拡張（オプション）**:
- ファイルプレビュー機能（テキスト・画像）
- グローバルトースト通知システム
- アップロード/ダウンロード進捗バー

**💡 設計変更点**:
- **進捗表示**: モーダルブロッキングではなく、リアルタイム状態表示を採用
- **エラーハンドリング**: トースト通知ではなく、ページ内エラー表示を採用
- **TypeScript**: interface → type への現代化
- **API設計**: camelCase JSONフィールドで統一

s3cは設計通りの機能を持つ、本格的なS3管理ツールとして完成している。


